{% extends "base.html" %}

{% block title %}ç¼–è¾‘åŒæ­¥é…ç½® - {{ config.config_key }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>âš™ï¸ ç¼–è¾‘åŒæ­¥é…ç½®</h2>
                <a href="{{ url_for('sync_management.sync_configs') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨
                </a>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <code>{{ config.config_key }}</code>
                        <span class="badge bg-{% if config.is_active %}success{% else %}secondary{% endif %} ms-2">
                            {% if config.is_active %}å¯ç”¨{% else %}ç¦ç”¨{% endif %}
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if config.description %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> {{ config.description }}
                    </div>
                    {% endif %}

                    <form method="POST">
                        <div class="mb-3">
                            <label for="config_value" class="form-label">
                                <strong>é…ç½®å€¼</strong>
                                <small class="text-muted">(æ”¯æŒJSONæ ¼å¼)</small>
                            </label>
                            <textarea class="form-control font-monospace" id="config_value" name="config_value" 
                                      rows="10" required>{{ formatted_value }}</textarea>
                            <div class="form-text">
                                æ”¯æŒJSONæ ¼å¼çš„å¯¹è±¡å’Œæ•°ç»„ï¼Œæˆ–è€…ç®€å•çš„å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">é…ç½®æè¿°</label>
                            <input type="text" class="form-control" id="description" name="description" 
                                   value="{{ config.description or '' }}" placeholder="é…ç½®çš„ç”¨é€”å’Œè¯´æ˜">
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       value="1" {% if config.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    å¯ç”¨æ­¤é…ç½®
                                </label>
                            </div>
                            <div class="form-text text-muted">
                                ç¦ç”¨çš„é…ç½®ä¸ä¼šç”Ÿæ•ˆï¼Œä½†ä¼šä¿ç•™é…ç½®å€¼
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save"></i> ä¿å­˜é…ç½®
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-info w-100" onclick="formatJSON()">
                                    <i class="fas fa-code"></i> æ ¼å¼åŒ–JSON
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- é…ç½®ç¤ºä¾‹å’Œè¯´æ˜ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ“š é…ç½®ç¤ºä¾‹å’Œè¯´æ˜</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <h6>app_data_overwrite_policy ç¤ºä¾‹:</h6>
                            <pre class="bg-light p-3 rounded"><code>{
  "users": true,
  "chantings": false,
  "dedication_templates": false,
  "chanting_records": true,
  "daily_stats": true,
  "dedications": true
}</code></pre>
                        </div>
                        <div class="col-lg-6">
                            <h6>sync_rate_limit ç¤ºä¾‹:</h6>
                            <pre class="bg-light p-3 rounded"><code>{
  "max_requests_per_hour": 60,
  "max_requests_per_day": 500
}</code></pre>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-lg-6">
                            <h6>built_in_content_protection ç¤ºä¾‹:</h6>
                            <pre class="bg-light p-3 rounded"><code>{
  "strict_mode": true,
  "protected_fields": [
    "title", "content", "pronunciation", 
    "type", "is_built_in"
  ],
  "admin_only_operations": [
    "create_built_in", 
    "update_built_in", 
    "delete_built_in"
  ],
  "allow_user_content_only": true
}</code></pre>
                        </div>
                        <div class="col-lg-6">
                            <h6>sync_allowed_data_types ç¤ºä¾‹:</h6>
                            <pre class="bg-light p-3 rounded"><code>[
  "users",
  "chantings", 
  "dedication_templates",
  "chanting_records",
  "daily_stats",
  "dedications"
]</code></pre>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-exclamation-triangle"></i> é‡è¦æç¤º</h6>
                        <ul class="mb-0">
                            <li><strong>è°¨æ…ä¿®æ”¹ï¼š</strong> é…ç½®æ›´æ”¹ä¼šç«‹å³ç”Ÿæ•ˆï¼Œå¯èƒ½å½±å“appçš„åŒæ­¥åŠŸèƒ½</li>
                            <li><strong>JSONæ ¼å¼ï¼š</strong> å¯¹è±¡å’Œæ•°ç»„å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼</li>
                            <li><strong>å¤‡ä»½å»ºè®®ï¼š</strong> ä¿®æ”¹å‰å»ºè®®è®°å½•åŸå§‹é…ç½®å€¼</li>
                            <li><strong>æµ‹è¯•éªŒè¯ï¼š</strong> ä¿®æ”¹åå»ºè®®è¿›è¡ŒåŒæ­¥æµ‹è¯•</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- é…ç½®å†å²ä¿¡æ¯ -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ• é…ç½®ä¿¡æ¯</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>é…ç½®ID:</strong> {{ config.id }}
                        </div>
                        <div class="col-md-4">
                            <strong>åˆ›å»ºæ—¶é—´:</strong><br>
                            <small>{{ config.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                        <div class="col-md-4">
                            <strong>æœ€åæ›´æ–°:</strong><br>
                            <small>{{ config.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function formatJSON() {
    const textarea = document.getElementById('config_value');
    const value = textarea.value.trim();
    
    try {
        // å°è¯•è§£æå¹¶æ ¼å¼åŒ–JSON
        const parsed = JSON.parse(value);
        const formatted = JSON.stringify(parsed, null, 2);
        textarea.value = formatted;
        
        // æç¤ºæˆåŠŸ
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">JSONæ ¼å¼åŒ–æˆåŠŸ</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        // ä½¿ç”¨Bootstrap 4å…¼å®¹çš„Toastæ˜¾ç¤ºï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        $(toast).addClass('show');
        
        // è‡ªåŠ¨æ¸…ç†
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
        
    } catch (e) {
        // ä¸æ˜¯JSONæ ¼å¼ï¼Œæç¤ºç”¨æˆ·
        alert('å½“å‰å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼Œæ— æ³•æ ¼å¼åŒ–ã€‚\\né”™è¯¯ä¿¡æ¯: ' + e.message);
    }
}

// è¡¨å•æäº¤å‰éªŒè¯
document.querySelector('form').addEventListener('submit', function(e) {
    const textarea = document.getElementById('config_value');
    const value = textarea.value.trim();
    
    // å¦‚æœçœ‹èµ·æ¥åƒJSONï¼ŒéªŒè¯æ ¼å¼
    if (value.startsWith('{') || value.startsWith('[')) {
        try {
            JSON.parse(value);
        } catch (e) {
            if (!confirm('é…ç½®å€¼çœ‹èµ·æ¥åƒJSONæ ¼å¼ï¼Œä½†æ ¼å¼æ— æ•ˆã€‚ç¡®å®šè¦ä¿å­˜å—ï¼Ÿ\\né”™è¯¯ä¿¡æ¯: ' + e.message)) {
                e.preventDefault();
                return false;
            }
        }
    }
});
</script>

<style>
.font-monospace {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
}

pre code {
    font-size: 12px;
}

.toast {
    min-width: 300px;
}
</style>
{% endblock %}