{% extends "base.html" %}

{% block title %}统计报表{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-bar mr-2"></i>统计报表
        </h1>
    </div>
    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-lg-3 col-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_chantings }}</h4>
                            <p class="mb-0">总佛号经文</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dharmachakra fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_records }}</h4>
                            <p class="mb-0">修行记录</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-journal-whills fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ today_total_count }}</h4>
                            <p class="mb-0">今日念诵</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-day fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_dedications }}</h4>
                            <p class="mb-0">回向文</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hands fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 每日统计详情 -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-calendar-alt mr-2"></i>每日修行详情
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 200px;">
                            <input type="date" class="form-control" id="dateFilter" value="{{ selected_date or today }}">
                            <div class="input-group-append">
                                <button class="btn btn-default" onclick="filterByDate()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th>佛号经文</th>
                                    <th>类型</th>
                                    <th>今日念诵</th>
                                    <th>累计念诵</th>
                                    <th>修行天数</th>
                                    <th>最后更新</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in daily_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ stat.chanting.title }}</strong>
                                        {% if stat.chanting.is_built_in %}
                                        <span class="badge badge-info ml-1">内置</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if stat.chanting.type == 'buddha' %}
                                        <span class="badge badge-warning">佛号</span>
                                        {% else %}
                                        <span class="badge badge-success">经文</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-primary">{{ stat.today_count or 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">{{ stat.total_count or 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="text-info">{{ stat.practice_days or 0 }} 天</span>
                                    </td>
                                    <td class="small text-muted">
                                        {{ stat.last_updated.strftime('%H:%M') if stat.last_updated else '-' }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterByDate() {
    const date = $('#dateFilter').val();
    if (date) {
        window.location.href = `{{ url_for('stats.index') }}?date=${date}`;
    }
}

// 实时更新功能（每5分钟刷新一次）
setInterval(function() {
    // 只在当前日期时才自动刷新
    const today = new Date().toISOString().split('T')[0];
    const selectedDate = $('#dateFilter').val();
    
    if (selectedDate === today) {
        location.reload();
    }
}, 300000); // 5分钟
</script>
{% endblock %}