{% extends "base.html" %}

{% block title %}ç¼–è¾‘ç”¨æˆ· - {{ user.username }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢å¯¼èˆª -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('users.index') }}">ç”¨æˆ·ç®¡ç†</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('users.detail', user_id=user.id) }}">{{ user.username }}</a></li>
            <li class="breadcrumb-item active">ç¼–è¾‘</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
                    </h5>
                </div>
                <form method="POST">
                    <div class="card-body">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">
                                        <i class="fas fa-user me-1"></i>ç”¨æˆ·å
                                    </label>
                                    <input type="text" class="form-control" id="username" 
                                           value="{{ user.username }}" readonly>
                                    <div class="form-text">ç”¨æˆ·åä¸å¯ä¿®æ”¹</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nickname" class="form-label">
                                        <i class="fas fa-tag me-1"></i>æ˜µç§°
                                    </label>
                                    <input type="text" class="form-control" id="nickname" name="nickname"
                                           value="{{ user.nickname or '' }}" maxlength="50">
                                    <div class="form-text">ç”¨æˆ·çš„æ˜¾ç¤ºåç§°</div>
                                </div>
                            </div>
                        </div>

                        <!-- å¤´åƒè®¾ç½® -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-image me-1"></i>å¤´åƒè®¾ç½®
                            </label>
                            
                            <!-- å¤´åƒç±»å‹é€‰æ‹© -->
                            <div class="mb-3">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="avatar_type" id="avatar_type_emoji" 
                                           value="emoji" {% if user.avatar_type == 'emoji' %}checked{% endif %}>
                                    <label class="btn btn-outline-primary" for="avatar_type_emoji">
                                        ğŸ˜Š è¡¨æƒ…å¤´åƒ
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="avatar_type" id="avatar_type_image" 
                                           value="image" {% if user.avatar_type == 'image' %}checked{% endif %}>
                                    <label class="btn btn-outline-success" for="avatar_type_image">
                                        ğŸ–¼ï¸ å›¾ç‰‡å¤´åƒ
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="avatar_type" id="avatar_type_default" 
                                           value="" {% if not user.avatar_type or user.avatar_type == 'default' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary" for="avatar_type_default">
                                        ğŸ‘¤ é»˜è®¤å¤´åƒ
                                    </label>
                                </div>
                            </div>
                            
                            <!-- å½“å‰å¤´åƒé¢„è§ˆ -->
                            <div class="mb-3">
                                <label class="form-label">å½“å‰å¤´åƒ</label>
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        {% if user.avatar_type == 'emoji' %}
                                            <span style="font-size: 3em;" id="avatar_preview">{{ user.avatar or 'ğŸ‘¤' }}</span>
                                        {% elif user.avatar_type == 'image' %}
                                            <img src="{{ user.avatar }}" class="rounded-circle" width="60" height="60" 
                                                 id="avatar_preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                            <span style="font-size: 3em; display: none;">ğŸ‘¤</span>
                                        {% else %}
                                            <span style="font-size: 3em;" id="avatar_preview">ğŸ‘¤</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <small class="text-muted">
                                            ç±»å‹ï¼š{{ user.avatar_type or 'é»˜è®¤' }}<br>
                                            å†…å®¹ï¼š{{ user.avatar or 'æ— ' }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¤´åƒå†…å®¹è¾“å…¥ -->
                            <div class="mb-3" id="avatar_input_group">
                                <label for="avatar" class="form-label">å¤´åƒå†…å®¹</label>
                                <input type="text" class="form-control" id="avatar" name="avatar"
                                       value="{{ user.avatar or '' }}" maxlength="500">
                                <div class="form-text" id="avatar_help">
                                    {% if user.avatar_type == 'emoji' %}
                                        è¾“å…¥ä¸€ä¸ªè¡¨æƒ…ç¬¦å·ï¼Œå¦‚ï¼šğŸ˜Š ğŸ™ ğŸŒ¸
                                    {% elif user.avatar_type == 'image' %}
                                        è¾“å…¥å›¾ç‰‡URLåœ°å€
                                    {% else %}
                                        ä½¿ç”¨é»˜è®¤å¤´åƒæ—¶æ— éœ€è¾“å…¥å†…å®¹
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- å¯†ç è®¾ç½® -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-lock me-1"></i>å¯†ç è®¾ç½®
                            </label>
                            
                            <div class="mb-3">
                                <label for="new_password" class="form-label">æ–°å¯†ç </label>
                                <input type="password" class="form-control" id="new_password" name="new_password"
                                       minlength="6" maxlength="50">
                                <div class="form-text">ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ï¼Œæœ€å°‘6ä½å­—ç¬¦</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                                       minlength="6" maxlength="50">
                                <div class="invalid-feedback" id="password_error">
                                    ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´
                                </div>
                            </div>
                        </div>

                        <!-- ç”¨æˆ·çŠ¶æ€ -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-info-circle me-1"></i>è´¦æˆ·ä¿¡æ¯
                            </label>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">æ³¨å†Œæ—¶é—´</h6>
                                            <p class="card-text">
                                                {% if user.created_at %}
                                                    {{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                                {% else %}
                                                    æœªçŸ¥
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">ç”¨æˆ·ID</h6>
                                            <p class="card-text">{{ user.id }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{{ url_for('users.detail', user_id=user.id) }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>è¿”å›
                                </a>
                            </div>
                            <div>
                                <button type="button" class="btn btn-warning me-2" onclick="resetForm()">
                                    <i class="fas fa-undo me-1"></i>é‡ç½®
                                </button>
                                <button type="submit" class="btn btn-success" id="submit_btn">
                                    <i class="fas fa-save me-1"></i>ä¿å­˜æ›´æ”¹
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// å¤´åƒç±»å‹åˆ‡æ¢
document.querySelectorAll('input[name="avatar_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        updateAvatarInput(this.value);
    });
});

// å¯†ç ç¡®è®¤éªŒè¯
document.getElementById('confirm_password').addEventListener('input', function() {
    const password = document.getElementById('new_password').value;
    const confirm = this.value;
    const errorDiv = document.getElementById('password_error');
    const submitBtn = document.getElementById('submit_btn');
    
    if (password && confirm && password !== confirm) {
        this.classList.add('is-invalid');
        submitBtn.disabled = true;
    } else {
        this.classList.remove('is-invalid');
        submitBtn.disabled = false;
    }
});

// å¤´åƒå†…å®¹å®æ—¶é¢„è§ˆ
document.getElementById('avatar').addEventListener('input', function() {
    const avatarType = document.querySelector('input[name="avatar_type"]:checked').value;
    const avatarValue = this.value;
    const preview = document.getElementById('avatar_preview');
    
    if (avatarType === 'emoji' && avatarValue) {
        preview.textContent = avatarValue;
    } else if (avatarType === 'image' && avatarValue) {
        if (preview.tagName === 'IMG') {
            preview.src = avatarValue;
        }
    }
});

function updateAvatarInput(type) {
    const avatarInput = document.getElementById('avatar');
    const helpText = document.getElementById('avatar_help');
    
    switch(type) {
        case 'emoji':
            helpText.textContent = 'è¾“å…¥ä¸€ä¸ªè¡¨æƒ…ç¬¦å·ï¼Œå¦‚ï¼šğŸ˜Š ğŸ™ ğŸŒ¸';
            avatarInput.placeholder = 'ğŸ˜Š';
            avatarInput.disabled = false;
            break;
        case 'image':
            helpText.textContent = 'è¾“å…¥å›¾ç‰‡URLåœ°å€';
            avatarInput.placeholder = 'https://example.com/avatar.jpg';
            avatarInput.disabled = false;
            break;
        case '':
        case 'default':
            helpText.textContent = 'ä½¿ç”¨é»˜è®¤å¤´åƒæ—¶æ— éœ€è¾“å…¥å†…å®¹';
            avatarInput.placeholder = '';
            avatarInput.disabled = true;
            avatarInput.value = '';
            break;
    }
}

function resetForm() {
    if (confirm('ç¡®å®šè¦é‡ç½®è¡¨å•å—ï¼Ÿæ‰€æœ‰æœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
        location.reload();
    }
}

// åˆå§‹åŒ–å¤´åƒè¾“å…¥çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    const checkedType = document.querySelector('input[name="avatar_type"]:checked');
    if (checkedType) {
        updateAvatarInput(checkedType.value);
    }
});
</script>
{% endblock %}